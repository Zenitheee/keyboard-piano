# 键盘钢琴项目 (Keyboard Piano)

基于STM32F4的ZLG7290键盘钢琴实现，支持热启动状态恢复功能。

## 功能特性

- **9个音阶支持**: 键盘1-9对应C4到D5音阶
- **ZLG7290键盘控制器**: 通过I2C接口通信，支持中断触发
- **热启动恢复**: 设备重启时自动恢复到重启前的状态，用户无感知
- **实时音频播放**: 按键按下即时播放对应音符
- **状态持久化**: 使用备份SRAM保存状态，断电不丢失

## 硬件连接

### 蜂鸣器连接
- **PG6**: 蜂鸣器控制引脚

### ZLG7290键盘控制器连接
#### I2C接口
- **PB6**: I2C1_SCL (时钟线)
- **PB7**: I2C1_SDA (数据线)

#### 中断接口
- **PD13**: ZLG7290中断输出引脚 (下降沿触发)

### ZLG7290键盘布局
```
[1] [2] [3]
[4] [5] [6]
[7] [8] [9]
```

## 音阶对应关系

| 键盘按键 | 音符 | 频率(Hz) | ZLG7290键值 | 说明 |
|---------|------|----------|-------------|------|
| 1       | C4   | 262      | 0x1C        | 中央C |
| 2       | D4   | 294      | 0x1B        | D音 |
| 3       | E4   | 330      | 0x1A        | E音 |
| 4       | F4   | 349      | 0x14        | F音 |
| 5       | G4   | 392      | 0x13        | G音 |
| 6       | A4   | 440      | 0x12        | A音 |
| 7       | B4   | 494      | 0x0C        | B音 |
| 8       | C5   | 523      | 0x0B        | 高音C |
| 9       | D5   | 587      | 0x0A        | 高音D |

## 工作原理

### 键盘检测流程
1. **中断触发**: 按键按下时，ZLG7290拉低PD13引脚
2. **中断处理**: GPIO中断设置key_flag标志
3. **I2C读取**: 主循环检测到标志后，通过I2C读取按键值
4. **键值映射**: 将ZLG7290键值映射为1-9按键编号
5. **音符播放**: 根据按键编号播放对应音符

### 热启动功能

#### 工作原理
- 使用STM32F4的备份SRAM存储状态信息
- 每100ms自动保存当前状态
- 按键状态变化时立即保存
- 设备重启时自动检测并恢复状态

#### 状态信息包含
- 当前按下的按键
- 播放状态
- 播放持续时间
- 数据完整性校验

#### 热启动特点
- **用户无感知**: 重启后自动恢复，用户体验连续
- **数据安全**: 使用魔数和校验和验证数据完整性
- **断电保护**: 备份SRAM在主电源断开时由备用电池供电

## 编译和使用

### 开发环境
- STM32CubeMX
- Keil MDK-ARM
- STM32F4xx HAL库

### 编译步骤
1. 使用STM32CubeMX打开 `Beep.ioc` 文件
2. 生成代码到MDK-ARM项目
3. 在Keil中打开项目文件
4. 编译并下载到STM32F4开发板

### 使用方法
1. 连接ZLG7290键盘控制器按照上述引脚定义
2. 下载程序到开发板
3. 按下ZLG7290键盘上的1-9按键
4. 蜂鸣器会播放对应的音符
5. 测试热启动：在播放过程中重启设备，观察是否自动恢复

## 代码结构

```
2_Beep/
├── Src/
│   ├── main.c          # 主程序，包含钢琴逻辑和热启动功能
│   ├── zlg7290.c       # ZLG7290键盘控制器驱动
│   ├── i2c.c           # I2C接口配置
│   └── gpio.c          # GPIO配置
├── Inc/
│   ├── zlg7290.h       # ZLG7290驱动头文件
│   └── i2c.h           # I2C接口头文件
└── README.md           # 本文件
```

## 技术细节

### 音频生成
- 使用GPIO输出方波信号驱动蜂鸣器
- 通过控制高低电平持续时间产生不同频率
- 实时计算延时参数确保音频准确性

### ZLG7290通信
- I2C地址: 0x71 (读取), 0x70 (写入)
- 键值寄存器: 0x01
- 中断方式: 下降沿触发
- 通信速度: 100kHz

### 热启动实现
- 备份SRAM地址: 0x40024000
- 魔数验证: 0xDEADBEEF
- 校验和算法确保数据完整性
- 自动状态恢复机制

## 注意事项

1. **硬件连接**: 确保ZLG7290正确连接到I2C和中断引脚
2. **电源管理**: 热启动功能需要备用电池支持备份SRAM
3. **I2C地址**: ZLG7290的I2C地址可能需要根据硬件配置调整
4. **中断优先级**: 确保中断优先级配置正确

## 故障排除

### 按键无响应
1. 检查I2C连接是否正确
2. 检查中断引脚PD13连接
3. 使用示波器检查I2C通信
4. 验证ZLG7290电源供电

### 音频问题
1. 检查蜂鸣器连接到PG6
2. 验证音频频率计算
3. 检查GPIO输出配置

## 扩展功能

可以在此基础上扩展以下功能：
- 和弦播放支持
- 音量控制
- 节拍器功能
- MIDI输出
- 录音回放功能 